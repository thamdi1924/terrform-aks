# Azure DevOps pipeline for Azure deployment

#variables:
#- group: terraform-tuesdays

trigger:
  branches:
    include:
    - main
  # paths:
  #  include:
  # - 2021-05-11-ADO/vnet
pool:
  vmImage: ubuntu-latest

stages:
- stage: Validate_stage
  displayName: Validate
  jobs:
  - job: validate_job

    steps:
    - task: TerraformInstaller@0
      displayName: Install Terraform
      inputs:
        terraformVersion: 'latest'

  # Init
    - task: TerraformTaskV3@3
      displayName: Initiate Terraform
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: 'sc-terraform2'
        backendAzureRmResourceGroupName: 'rg-terraform'
        backendAzureRmStorageAccountName: 'stterraform2022'
        backendAzureRmContainerName: 'stcontainerterraform'
        backendAzureRmKey: 'terraform.tfstate'

         # Validate
    - task: TerraformTaskV3@3
      displayName: Validate Config
      inputs:
        command: 'validate'

    - task: TerraformTaskV3@3
      displayName: execute plan
      inputs:
        provider: 'azurerm'
        environmentServiceNameAzureRM: 'sc-terraform2'
        command: 'plan'
        commandOptions: '-out tarigplan.out'

    - task: TerraformTaskV3@3
      displayName: Apply Terraform Deployment
      inputs:
           provider: 'azurerm'
           environmentServiceNameAzureRM: 'sc-terraform2'
           ARM_CLIENT_ID: '12751642-d049-4e33-a5c4-ed624669a496'
           ARM_CLIENT_SECRET: '751b09b0-6d69-4410-bdd8-20010721071a'
           ARM_SUBSCRIPTION_ID: 'b2cb661a-f958-440c-b39d-6d0a0b28de4c'
           command: 'apply'
           commandOptions: '-auto-approve'
  
  
    - task: TerraformTaskV3@3
      displayName: Apply Terraform Deployment
      inputs:
           provider: 'azurerm'
           environmentServiceNameAzureRM: 'sc-terraform2'
           command: 'destroy'
  

  - job: Get_approval
    dependsOn: validate_job
    pool: server
    steps: 
    - task: ManualValidation@0
      displayName: wait for approval
      timeoutInMinutes: 60
      inputs:
        notifyUsers: 'thamdi@solutions.com.sa'
        instructions: 'Review the plan in the next hour'
     
  - job: Terraform_apply
    dependsOn: Get_approval    
    steps:
    - task: TerraformTaskV3@3
      displayName: Apply Terraform Deployment
      inputs:
         provider: 'azurerm'
         environmentServiceNameAzureRM: 'sc-terraform2'
         command: 'apply'
         commandOptions: '-auto-approve'


    - task: TerraformTaskV3@3
      displayName: Apply Terraform Deployment
      inputs:
         provider: 'azurerm'
         environmentServiceNameAzureRM: 'sc-terraform2'
         command: 'destroy'



      



